<!-- Ostatak tvoje <head> ostaje isti -->

<body>

<h1>üöó Parking ‚Äì Professor Parking</h1>
<h2 style="color: #047730;">
  Free spots: <span id="slobodna">15</span>
</h2>
 
<progress id="progressBar" max="15" value="0"></progress>
<div class="card">
  <form id="uploadForm">
    <label for="korisnikIme">Your name:</label>
    <input type="text" id="korisnikIme" placeholder="Enter your name" required>

    <label for="plate">Enter license plate (e.g., ABC-123):</label>
    <input type="text" id="plate" placeholder="ABC-123" required>

    <label for="vrijemeOd">Time from:</label>
    <input type="time" id="vrijemeOd" required>

    <label for="vrijemeDo">Time to:</label>
    <input type="time" id="vrijemeDo" required>

    <label for="mjestoSelect">Choose spot (1‚Äì15):</label>
    <select id="mjestoSelect" required size="5" style="height:100px; overflow-y: scroll;"></select>

    <button type="submit" id="rezervisiBtn">Reserve spot</button>
    <button type="reset" id="resetBtn">Clear</button>
  </form>
</div>

<div id="status"></div>
<div id="qrKod"></div>

<div class="card">
  <button id="prikaziZauzeta">Show taken spots</button>
  <div id="mjestaZauzeta"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "TVOJ_API_KEY",
    authDomain: "TVOJ_PROJECT.firebaseapp.com",
    databaseURL: "https://TVOJ_PROJECT.firebaseio.com",
    projectId: "TVOJ_PROJECT",
    storageBucket: "TVOJ_PROJECT.appspot.com",
    messagingSenderId: "TVOJ_SENDER_ID",
    appId: "TVOJ_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>

<script>
  const plateToProfessor = {
    "ABC-123": "Sabahudin Solak",
    "A12-K-456": "Professor Mehic",
    "T99-M-222": "Professor Zukic",
    "SG-123-AB": "Professor Dzafic",
    "K45-O-999": "Professor Imamovic"
  };

  function verifyPairing(plate, name) {
    if (!plateToProfessor[plate]) return { ok: false, msg: "‚ùå This license plate is not registered!" };
    if (plateToProfessor[plate] !== name) return { ok: false, msg: "‚ùå Name does NOT match license plate!" };
    return { ok: true, msg: "‚úî Allowed ‚Äî data matches." };
  }

  const freeSpan = document.getElementById("slobodna");
  const progressBar = document.getElementById("progressBar");
  const qrDiv = document.getElementById("qrKod");
  const statusDiv = document.getElementById("status");
  const placeSelect = document.getElementById("mjestoSelect");
  const showTakenBtn = document.getElementById("prikaziZauzeta");
  const takenPlacesDiv = document.getElementById("mjestaZauzeta");

  let freePlaces = 15;
  let takenPlaces = [];

  // --- Firebase real-time update ---
  database.ref('parking').on('value', snapshot => {
    const data = snapshot.val() || {};
    takenPlaces = Object.values(data);
    freePlaces = 15 - takenPlaces.length;
    freeSpan.textContent = freePlaces;
    progressBar.value = 15 - freePlaces;
    fillPlaces();
  });

  function fillPlaces() {
    placeSelect.innerHTML = "";
    for (let i = 1; i <= 15; i++) {
      if (!takenPlaces.some(p => p.place === i)) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        placeSelect.appendChild(option);
      }
    }
  }

  function professorAlreadyReserved(plate) {
    return takenPlaces.some(p => p.plate === plate);
  }

  function saveReservation(reservation) {
    // spremi u Firebase pod jedinstvenim ID-om
    const newRef = database.ref('parking').push();
    newRef.set(reservation);
  }

  document.getElementById("uploadForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const name = document.getElementById("korisnikIme").value.trim();
    const plate = document.getElementById("plate").value.trim().toUpperCase();
    const timeFrom = document.getElementById("vrijemeOd").value;
    const timeTo = document.getElementById("vrijemeDo").value;
    const selectedPlace = parseInt(placeSelect.value);

    const check = verifyPairing(plate, name);
    if (!check.ok) {
      statusDiv.innerHTML = `<span style="color:red; font-weight:bold;">${check.msg}</span>`;
      return;
    }

    if (professorAlreadyReserved(plate)) {
      statusDiv.innerHTML = `<span style="color:red; font-weight:bold;">‚ùå This professor already reserved a parking spot!</span>`;
      return;
    }

    const reservation = { place: selectedPlace, name, plate, timeFrom, timeTo };
    saveReservation(reservation);

    statusDiv.innerHTML = `
      <span style="color:lightgreen; font-weight:bold;">‚úî ${name} reserved spot ${selectedPlace}.</span>
      <br>Time: ${timeFrom} - ${timeTo}
    `;

    qrDiv.innerHTML = "";
    const canvas = document.createElement("canvas");
    const qr = new QRious({ element: canvas, size: 200, value: `OPEN_GATE|${plate}` });
    const label = document.createElement("div");
    label.style.color = "#ffcc00";
    label.style.marginBottom = "6px";
    label.textContent = "Scan this QR code to open the gate";
    qrDiv.appendChild(label);
    qrDiv.appendChild(qr.element);

    fillPlaces();
  });

  showTakenBtn.addEventListener("click", function() {
    if (takenPlaces.length === 0) {
      takenPlacesDiv.style.display = "block";
      takenPlacesDiv.innerHTML = "<span>No taken parking spots.</span>";
      return;
    }
    takenPlacesDiv.style.display = "block";
    let html = "<ul>";
    takenPlaces.forEach(p => {
      html += `<li>Spot ${p.place} - ${p.name} (${p.plate}) | ${p.timeFrom} - ${p.timeTo}</li>`;
    });
    html += "</ul>";
    takenPlacesDiv.innerHTML = html;
  });
</script>

</body>
</html>
